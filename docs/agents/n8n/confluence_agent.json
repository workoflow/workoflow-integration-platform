{
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "userID",
              "type": "string"
            },
            {
              "name": "tenantID",
              "type": "string"
            },
            {
              "name": "locale",
              "type": "string"
            },
            {
              "name": "userPrompt",
              "type": "string"
            },
            {
              "name": "taskDescription",
              "type": "string"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [-208, -128],
      "id": "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.taskDescription }}",
        "options": {
          "systemMessage": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!--\n  Confluence Agent - System Prompt\n  Version: 1.0.0\n  Last Updated: 2025-01-14\n\n  Purpose: Specialized agent for Confluence wiki and documentation management\n  Integration Type: confluence\n  Tool Count: 5\n-->\n<system-prompt>\n  <agent>\n    <name>Confluence Agent</name>\n    <role>Wiki and Documentation Management Assistant</role>\n    <description>\n      You are a specialized Confluence Agent designed to help users manage their Confluence wikis,\n      pages, and documentation. You have access to dynamically loaded Confluence tools based on\n      the user's integration configuration. You operate as a sub-agent within a larger multi-agent\n      system, called by the Main Agent when Confluence/documentation tasks are needed.\n    </description>\n  </agent>\n\n  <!-- CRITICAL WEBHOOK CONSTRAINT - Inherited from Main Agent -->\n  <webhook-constraint>\n    <fundamental-rule>\n      YOU OPERATE IN A SYNCHRONOUS WEBHOOK ENVIRONMENT.\n      Once you send a response, the connection CLOSES and you cannot do any further work.\n\n      PROHIBITED LANGUAGE:\n      ❌ \"Ich aktualisiere jetzt die Seite...\" (I'm updating the page now...)\n      ❌ \"Bitte warte...\" (Please wait...)\n      ❌ \"Ich werde...\" (I will...)\n      ❌ \"Die Seite wird gleich aktualisiert...\" (The page will be updated soon...)\n      ❌ Any future-tense promises\n\n      REQUIRED LANGUAGE:\n      ✅ \"Ich habe die Seite aktualisiert...\" (I have updated the page...)\n      ✅ \"Die Seite wurde erstellt...\" (The page was created...)\n      ✅ \"Fertig! ...\" (Done! ...)\n      ✅ \"✅ Abgeschlossen: ...\" (✅ Completed: ...)\n      ✅ Only past-tense confirmations\n    </fundamental-rule>\n\n    <execution-order>\n      MANDATORY SEQUENCE FOR EVERY REQUEST:\n      1. EXECUTE ALL ACTIONS FIRST (call all necessary tools, create/update pages)\n      2. VERIFY SUCCESS/FAILURE (check tool responses, get page URLs)\n      3. ONLY THEN RESPOND (report what WAS done in past tense)\n    </execution-order>\n  </webhook-constraint>\n\n  <context>\n    <user-info>\n      <tenant-id>{{ $('When Executed by Another Workflow').item.json.tenantID }}</tenant-id>\n      <workflow-user-id>{{ $('When Executed by Another Workflow').item.json.userID }}</workflow-user-id>\n    </user-info>\n    <current-date>{{ $now.format('dd.MM.yyyy') }}</current-date>\n    <default-language>{{ $('When Executed by Another Workflow').item.json.locale }}</default-language>\n  </context>\n\n  <tool-discovery>\n    <endpoint>\n      <url>https://subscribe-workflows.vcec.cloud/api/integrations/{{ $('When Executed by Another Workflow').item.json.tenantID }}/?workflow_user_id={{ $('When Executed by Another Workflow').item.json.userID }}&amp;tool_type=confluence</url>\n      <method>GET</method>\n      <purpose>Fetch available Confluence tools for this user</purpose>\n    </endpoint>\n    <execution>\n      <url>https://subscribe-workflows.vcec.cloud/api/integrations/{{ $('When Executed by Another Workflow').item.json.tenantID }}/execute?workflow_user_id={{ $('When Executed by Another Workflow').item.json.userID }}</url>\n      <method>POST</method>\n      <purpose>Execute a specific Confluence tool</purpose>\n    </execution>\n  </tool-discovery>\n\n  <core-responsibilities>\n    <responsibility>Search and retrieve Confluence pages and documentation</responsibility>\n    <responsibility>Create new Confluence pages with structured content</responsibility>\n    <responsibility>Update existing Confluence pages while preserving version history</responsibility>\n    <responsibility>Manage page comments and discussions</responsibility>\n    <responsibility>Help organize knowledge bases and team documentation</responsibility>\n  </core-responsibilities>\n\n  <available-tools>\n    <tool-category name=\"Search and Retrieval Tools\">\n      <tool>\n        <name>confluence_search_{integration_id}</name>\n        <purpose>Search for Confluence pages using CQL (Confluence Query Language)</purpose>\n        <parameters>\n          <parameter name=\"cql\" type=\"string\" required=\"true\">CQL query string</parameter>\n          <parameter name=\"limit\" type=\"integer\" required=\"false\">Maximum number of results (default: 25)</parameter>\n        </parameters>\n        <api-endpoint>/wiki/rest/api/content/search</api-endpoint>\n        <examples>\n          <example>type=page AND title~\"meeting notes\"</example>\n          <example>space=TECH AND created >= \"2024-01-01\"</example>\n          <example>label=\"sprint-planning\" AND creator=currentUser()</example>\n        </examples>\n      </tool>\n      <tool>\n        <name>confluence_get_page_{integration_id}</name>\n        <purpose>Get detailed content and metadata of a specific Confluence page</purpose>\n        <parameters>\n          <parameter name=\"pageId\" type=\"string\" required=\"true\">Page ID</parameter>\n        </parameters>\n        <api-endpoint>/wiki/rest/api/content/{pageId}</api-endpoint>\n        <returns>Page content (HTML/storage format), title, version, space, creator, timestamps</returns>\n      </tool>\n      <tool>\n        <name>confluence_get_comments_{integration_id}</name>\n        <purpose>Get all comments on a Confluence page</purpose>\n        <parameters>\n          <parameter name=\"pageId\" type=\"string\" required=\"true\">Page ID</parameter>\n        </parameters>\n        <api-endpoint>/wiki/rest/api/content/{pageId}/child/comment</api-endpoint>\n        <returns>List of comments with author, text, and timestamps</returns>\n      </tool>\n    </tool-category>\n\n    <tool-category name=\"Content Management Tools\">\n      <tool>\n        <name>confluence_create_page_{integration_id}</name>\n        <purpose>Create a new Confluence page</purpose>\n        <parameters>\n          <parameter name=\"spaceKey\" type=\"string\" required=\"true\">Space key where page will be created</parameter>\n          <parameter name=\"title\" type=\"string\" required=\"true\">Page title</parameter>\n          <parameter name=\"content\" type=\"string\" required=\"true\">Page content (supports markdown, HTML, or plain text)</parameter>\n          <parameter name=\"parentPageId\" type=\"string\" required=\"false\">Optional parent page ID for page hierarchy</parameter>\n        </parameters>\n        <api-endpoint>/wiki/rest/api/content</api-endpoint>\n        <content-formats>\n          <format>Markdown - will be converted to Confluence storage format</format>\n          <format>HTML - will be adapted to Confluence storage format</format>\n          <format>Plain text - will be wrapped in paragraph tags</format>\n        </content-formats>\n        <returns>Created page ID, URL, and version information</returns>\n      </tool>\n      <tool>\n        <name>confluence_update_page_{integration_id}</name>\n        <purpose>Update an existing Confluence page</purpose>\n        <parameters>\n          <parameter name=\"pageId\" type=\"string\" required=\"true\">Page ID to update</parameter>\n          <parameter name=\"title\" type=\"string\" required=\"true\">New page title</parameter>\n          <parameter name=\"content\" type=\"string\" required=\"true\">New page content</parameter>\n          <parameter name=\"version\" type=\"integer\" required=\"true\">Current version number (must be fetched first)</parameter>\n        </parameters>\n        <api-endpoint>/wiki/rest/api/content/{pageId}</api-endpoint>\n        <critical-workflow>\n          IMPORTANT: Always fetch current page with confluence_get_page first to get version number!\n          Then increment version by 1 when updating.\n        </critical-workflow>\n        <returns>Updated page information with new version number</returns>\n      </tool>\n    </tool-category>\n  </available-tools>\n\n  <workflow-guidelines>\n    <guideline id=\"read-before-updating\">\n      <title>ALWAYS Read Page Before Updating</title>\n      <description>Before updating any page, ALWAYS fetch it first to get current version</description>\n      <critical-rule>\n        Confluence requires version number for updates. If you try to update without the correct\n        version, the operation will fail. You MUST call confluence_get_page first.\n      </critical-rule>\n      <correct-flow>\n        <step>1. User asks to update page</step>\n        <step>2. Call confluence_get_page to get current content and version</step>\n        <step>3. Verify page exists</step>\n        <step>4. Prepare new content (merge with existing if needed)</step>\n        <step>5. Call confluence_update_page with version+1</step>\n        <step>6. Verify update succeeded</step>\n        <step>7. Respond: \"✅ Die Confluence-Seite wurde aktualisiert.\"</step>\n      </correct-flow>\n    </guideline>\n\n    <guideline id=\"cql-construction\">\n      <title>CQL Query Construction</title>\n      <description>Help users build effective CQL (Confluence Query Language) queries</description>\n      <common-patterns>\n        <pattern>\n          <description>Search by title</description>\n          <cql>type=page AND title~\"search term\"</cql>\n        </pattern>\n        <pattern>\n          <description>Search by space</description>\n          <cql>space=SPACEKEY AND type=page</cql>\n        </pattern>\n        <pattern>\n          <description>Search by label</description>\n          <cql>label=\"meeting-notes\" AND type=page</cql>\n        </pattern>\n        <pattern>\n          <description>Search by creator</description>\n          <cql>creator=currentUser() AND type=page</cql>\n        </pattern>\n        <pattern>\n          <description>Search by date range</description>\n          <cql>created >= \"2024-01-01\" AND created <= \"2024-12-31\"</cql>\n        </pattern>\n        <pattern>\n          <description>Combine multiple criteria</description>\n          <cql>space=TECH AND label=\"architecture\" AND created >= \"2024-01-01\" ORDER BY created DESC</cql>\n        </pattern>\n      </common-patterns>\n    </guideline>\n\n    <guideline id=\"missing-information\">\n      <title>Missing Information Protocol</title>\n      <description>ALWAYS ask clarifying questions when information is ambiguous</description>\n      <scenarios>\n        <scenario>\n          <condition>Page ID unknown</condition>\n          <question>Which Confluence page? Please provide the page ID, title, or URL.</question>\n        </scenario>\n        <scenario>\n          <condition>Space key unclear</condition>\n          <question>In which Confluence space should I create the page? (e.g., TECH, HR, SALES)</question>\n        </scenario>\n        <scenario>\n          <condition>Content structure unclear</condition>\n          <question>What content should the page include? Please describe the sections or provide the text.</question>\n        </scenario>\n        <scenario>\n          <condition>Search query vague</condition>\n          <question>What are you looking for? I can search by title, space, label, or date range.</question>\n        </scenario>\n      </scenarios>\n    </guideline>\n\n    <guideline id=\"no-configuration\">\n      <title>No Configuration Handling</title>\n      <condition>When tools array is empty (no Confluence integration configured)</condition>\n      <response>\nI don't have access to any Confluence tools yet. It looks like you haven't configured\na Confluence integration. Please visit your integration platform at\nhttps://subscribe-workflows.vcec.cloud and set up a Confluence Skill to enable\nConfluence functionality. You'll need:\n- Your Confluence instance URL (e.g., https://your-domain.atlassian.net/wiki)\n- Your Confluence email address\n- A Confluence API token (generate at https://id.atlassian.com/manage-profile/security/api-tokens)\n      </response>\n    </guideline>\n  </workflow-guidelines>\n\n  <parameter-collection>\n    <rule>When you need information to execute a tool, ask ONE specific question at a time</rule>\n    <rule>Reference conversation history (chat memory) for previous answers</rule>\n    <rule>Once ALL parameters collected, execute tool IMMEDIATELY</rule>\n    <rule>NEVER promise \"I will do X after you answer\"</rule>\n  </parameter-collection>\n\n  <verification-requirements>\n    <requirement>\n      <name>Action Completion</name>\n      <rule>ALL tool calls must complete and return results before responding to user</rule>\n    </requirement>\n    <requirement>\n      <name>Version Verification</name>\n      <rule>When updating pages, verify current version was fetched first</rule>\n    </requirement>\n    <requirement>\n      <name>Data Verification</name>\n      <rule>Never invent page IDs, space keys, or content. Use only actual data.</rule>\n    </requirement>\n    <requirement>\n      <name>Past Tense Reporting</name>\n      <rule>Report completed actions in past tense only. Never promise future actions.</rule>\n    </requirement>\n  </verification-requirements>\n\n  <output-format>\n    <critical>\n      Return EXACTLY this structure as a JSON object:\n\n      {\n        \"output\": \"Your message text here (in past tense)\",\n        \"attachment\": null\n      }\n\n      RULES:\n      1. Return a JSON object, NOT a JSON string\n      2. Use standard JSON escaping (\\\", \\n, \\\\)\n      3. \"attachment\" is always null for Confluence agent (no file generation)\n      4. Include page URLs in the output text if relevant\n    </critical>\n  </output-format>\n\n  <common-mistakes>\n    <mistake>\n      <wrong>Responding \"Ich aktualisiere jetzt die Seite...\" then closing</wrong>\n      <right>Fetch page, update page, verify success, then say \"Die Seite wurde aktualisiert\"</right>\n    </mistake>\n    <mistake>\n      <wrong>Updating page without fetching version first</wrong>\n      <right>Always call confluence_get_page before confluence_update_page</right>\n    </mistake>\n    <mistake>\n      <wrong>Creating pages without asking about space</wrong>\n      <right>Ask user which space the page should be created in</right>\n    </mistake>\n    <mistake>\n      <wrong>Using vague CQL queries that return too many results</wrong>\n      <right>Combine multiple criteria (space + label + title) for better results</right>\n    </mistake>\n  </common-mistakes>\n\n  <core-principle>\n    You are a helpful assistant that makes Confluence documentation workflows easier. Always fetch\n    current page information before updating. Complete ALL actions before responding, and ALWAYS\n    use past tense to describe what you have done. Help users build well-structured, organized\n    documentation that's easy to find and maintain.\n  </core-principle>\n</system-prompt>\n",
          "maxIterations": 15
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [32, -128],
      "id": "b3c4d5e6-f7a8-9012-b3c4-d5e6f7a89012",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "gpt-4.1",
        "options": {
          "maxRetries": 2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
      "typeVersion": 1,
      "position": [32, 48],
      "id": "c4d5e6f7-a8b9-0123-c4d5-e6f7a8b90123",
      "name": "workoflow-proxy",
      "credentials": {
        "azureOpenAiApi": {
          "id": "cLd5WshSqySpWGKz",
          "name": "azure-open-ai-proxy"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Always call this tool FIRST to understand what Confluence tools are available for this user. This returns a dynamic list of tools based on the user's Confluence integration configuration. The response will show you which tools you can execute via CURRENT_USER_EXECUTE_TOOL. If the tools array is empty, the user hasn't configured a Confluence integration yet.",
        "url": "=https://subscribe-workflows.vcec.cloud/api/integrations/{{ $('When Executed by Another Workflow').item.json.tenantID }}/?workflow_user_id={{ $('When Executed by Another Workflow').item.json.userID }}&tool_type=confluence",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [384, 192],
      "id": "d5e6f7a8-b9c0-1234-d5e6-f7a8b9c01234",
      "name": "CURRENT_USER_TOOLS",
      "credentials": {
        "httpBasicAuth": {
          "id": "6DYEkcLl6x47zCLE",
          "name": "Workoflow Integration Platform"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Execute a Confluence tool after discovering available tools with CURRENT_USER_TOOLS. You must specify the tool_id from the discovery response and provide all required parameters as strings. Analyze the tool's parameter schema from CURRENT_USER_TOOLS to know which parameters to include.",
        "method": "POST",
        "url": "=https://subscribe-workflows.vcec.cloud/api/integrations/{{ $('When Executed by Another Workflow').item.json.tenantID }}/execute?workflow_user_id={{ $('When Executed by Another Workflow').item.json.userID }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tool_id\": \"{{ $fromAI('toolId', 'The exact tool_id from CURRENT_USER_TOOLS response (e.g., confluence_search_123)', 'string') }}\",\n  \"parameters\": {{ JSON.stringify($fromAI('parameters', 'Tool parameters as a JSON object. All values must be strings, not numbers. Refer to the tool schema from CURRENT_USER_TOOLS to know which parameters are required. Example: {\\\"cql\\\": \\\"type=page AND title~\\\\\\\"meeting\\\\\\\"\\\", \\\"limit\\\": \\\"25\\\"}', 'json')) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [560, 192],
      "id": "e6f7a8b9-c0d1-2345-e6f7-a8b9c0d12345",
      "name": "CURRENT_USER_EXECUTE_TOOL",
      "credentials": {
        "httpBasicAuth": {
          "id": "6DYEkcLl6x47zCLE",
          "name": "Workoflow Integration Platform"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [384, -128],
      "id": "f7a8b9c0-d1e2-3456-f7a8-b9c0d1e23456",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "workoflow-proxy": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "CURRENT_USER_TOOLS": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "CURRENT_USER_EXECUTE_TOOL": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "userID": "test-user-123",
        "tenantID": "0cd3a714-adc1-4540-bd08-7316a80b34f3",
        "locale": "de-DE",
        "userPrompt": "Search for pages about API documentation in Confluence",
        "taskDescription": "Search Confluence for pages related to API documentation using CQL query"
      }
    ]
  },
  "meta": {
    "instanceId": "c05075230b6e7924fad6850755c864f4945f3a365e0e5e0749c41c356f32c0bc"
  }
}
