{% extends 'base.html.twig' %}

{% block title %}{{ 'general.title'|trans }} - Workoflow{% endblock %}

{% block body %}
<div class="dashboard-page">
    
    <div class="dashboard-container">
        <h1 class="dashboard-title">{{ 'general.welcome'|trans({'%name%': user.name}) }}</h1>
        
        {% if organisation %}
            <div class="organisation-info">
                <h5>{{ 'general.organisation'|trans }}</h5>
                <p class="org-name">{{ organisation.name }}</p>
                <p class="org-api-url">
                    <span class="label">{{ 'general.integration_api_url'|trans }}:</span>
                    <code>{{ organisation.integrationApiUrl }}</code>
                </p>
                {% if userOrganisation and userOrganisation.workflowUserId %}
                <p class="org-api-url">
                    <span class="label">{{ 'general.workflow_user_id'|trans|default('Workflow User ID') }}:</span>
                    <code>{{ userOrganisation.workflowUserId }}</code>
                </p>
                <div class="curl-command-section">
                    <button type="button" id="copyCurlBtn" class="btn btn-secondary btn-copy-curl">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        {{ 'general.copy_curl_command'|trans|default('Copy curl command for tools') }}
                    </button>
                    <span id="copiedMessage" class="copied-message" style="display: none;">{{ 'general.copied'|trans|default('Copied!') }}</span>
                </div>
                {% endif %}
            </div>
        {% endif %}

        <div class="stats-grid">
            <div class="stat-card">
                <h2 class="stat-number">{{ integrations|length }}</h2>
                <p class="stat-label">{{ 'general.integrations_count'|trans }}</p>
                <a href="{{ path('app_skills') }}" class="btn btn-primary">
                    {{ 'general.manage_integrations'|trans }}
                </a>
            </div>
            
            <div class="stat-card">
                <h2 class="stat-number">{{ integrations|filter(i => i.active)|length }}</h2>
                <p class="stat-label">{{ 'general.active_integrations'|trans }}</p>
            </div>

            <div class="stat-card">
                <h2 class="stat-number">{{ user.isAdmin() ? 'Admin' : 'Member' }}</h2>
                <p class="stat-label">{{ 'general.your_role'|trans }}</p>
            </div>
        </div>

        {% if integrations|length > 0 %}
            <div class="integrations-section">
                <h3>{{ 'general.recent_integrations'|trans }}</h3>
                <div class="integrations-table">
                    <table>
                        <thead>
                            <tr>
                                <th>{{ 'integration.name'|trans }}</th>
                                <th>{{ 'integration.type'|trans }}</th>
                                <th>{{ 'integration.status'|trans }}</th>
                                <th>{{ 'integration.last_accessed'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for integration in integrations|slice(0, 5) %}
                                <tr>
                                    <td>{{ integration.name }}</td>
                                    <td>
                                        <span class="badge badge-type"{% if integration.isExperimental %} title="{{ 'status.experimental'|trans|default('Experimental') }}"{% endif %}>
                                            {% if integration.isExperimental %}<i class="fas fa-flask"></i> {% endif %}{{ integration.type|upper }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if integration.active %}
                                            <span class="badge badge-active">{{ 'status.active'|trans }}</span>
                                        {% else %}
                                            <span class="badge badge-inactive">{{ 'status.inactive'|trans }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ integration.lastAccessedAt ? integration.lastAccessedAt|date('d.m.Y H:i') : 'general.never'|trans }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.curl-command-section {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.btn-copy-curl {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-copy-curl:hover {
    background-color: #5a6268;
}

.copied-message {
    color: #28a745;
    font-weight: 500;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const copyCurlBtn = document.getElementById('copyCurlBtn');
    const copiedMessage = document.getElementById('copiedMessage');

    if (copyCurlBtn) {
        copyCurlBtn.addEventListener('click', function() {
            // Get the current domain
            const currentDomain = window.location.origin;

            // Get organisation UUID from the API URL
            const orgUuid = '{{ organisation.uuid }}';

            // Get workflow user ID
            const workflowUserId = '{{ userOrganisation.workflowUserId }}';

            // Construct the curl command
            const apiUrl = `${currentDomain}/api/integrations/${orgUuid}?workflow_user_id=${workflowUserId}`;
            const curlCommand = `curl -X GET "${apiUrl}" \\
  -H "Accept: application/json" \\
  -H "Authorization: Basic YOUR_AUTH_TOKEN"`;

            // Copy to clipboard
            navigator.clipboard.writeText(curlCommand).then(function() {
                // Show success message
                copiedMessage.style.display = 'inline';

                // Hide message after 2 seconds
                setTimeout(function() {
                    copiedMessage.style.display = 'none';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        });
    }
});
</script>
{% endblock %}