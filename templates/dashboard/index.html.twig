{% extends 'base.html.twig' %}

{% block title %}{{ 'general.title'|trans }} - Workoflow{% endblock %}

{% block body %}
<div class="dashboard-page">
    {% include '_partials/header.html.twig' %}
    
    <div class="dashboard-container">
        <h1 class="dashboard-title">{{ 'general.welcome'|trans({'%name%': user.name}) }}</h1>
        
        {% if organisation %}
            <div class="organisation-info">
                <h5>{{ 'general.organisation'|trans }}</h5>
                {% if is_granted('ROLE_ADMIN') %}
                    <div class="org-name-editable">
                        <p class="org-name" id="orgName" contenteditable="false">{{ organisation.name }}</p>
                        <button type="button" id="editOrgNameBtn" class="btn-icon-edit" title="{{ 'general.edit_org_name'|trans }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button type="button" id="saveOrgNameBtn" class="btn-icon-save" style="display: none;" title="{{ 'general.save_org_name'|trans }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </button>
                        <button type="button" id="cancelOrgNameBtn" class="btn-icon-cancel" style="display: none;" title="{{ 'general.cancel_edit'|trans }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                {% else %}
                    <p class="org-name">{{ organisation.name }}</p>
                {% endif %}
                <p class="org-api-url">
                    <span class="label">{{ 'general.integration_api_url'|trans }}:</span>
                    <code>{{ organisation.integrationApiUrl }}</code>
                </p>
                {% if userOrganisation and userOrganisation.workflowUserId %}
                <p class="org-api-url">
                    <span class="label">{{ 'general.workflow_user_id'|trans|default('Workflow User ID') }}:</span>
                    <code>{{ userOrganisation.workflowUserId }}</code>
                </p>
                <div class="curl-command-section">
                    <button type="button" id="copyCurlBtn" class="btn btn-secondary btn-copy-curl">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        {{ 'general.copy_curl_command'|trans|default('Copy curl command for tools') }}
                    </button>
                    <span id="copiedMessage" class="copied-message" style="display: none;">{{ 'general.copied'|trans|default('Copied!') }}</span>
                </div>
                {% endif %}
            </div>
        {% endif %}

        <div class="stats-grid">
            <div class="stat-card">
                <h2 class="stat-number">{{ integrations|length }}</h2>
                <p class="stat-label">{{ 'general.integrations_count'|trans }}</p>
                <a href="{{ path('app_tools') }}" class="btn btn-primary">
                    {{ 'general.manage_integrations'|trans }}
                </a>
            </div>
            
            <div class="stat-card">
                <h2 class="stat-number">{{ integrations|filter(i => i.active)|length }}</h2>
                <p class="stat-label">{{ 'general.active_integrations'|trans }}</p>
            </div>

            <div class="stat-card">
                <h2 class="stat-number">{{ user.isAdmin() ? 'Admin' : 'Member' }}</h2>
                <p class="stat-label">{{ 'general.your_role'|trans }}</p>
            </div>
        </div>

        {% if integrations|length > 0 %}
            <div class="integrations-section">
                <h3>{{ 'general.recent_integrations'|trans }}</h3>
                <div class="integrations-table">
                    <table>
                        <thead>
                            <tr>
                                <th>{{ 'integration.name'|trans }}</th>
                                <th>{{ 'integration.type'|trans }}</th>
                                <th>{{ 'integration.status'|trans }}</th>
                                <th>{{ 'integration.last_accessed'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for integration in integrations|slice(0, 5) %}
                                <tr>
                                    <td>{{ integration.name }}</td>
                                    <td>
                                        <span class="badge badge-type">{{ integration.type|upper }}</span>
                                    </td>
                                    <td>
                                        {% if integration.active %}
                                            <span class="badge badge-active">{{ 'status.active'|trans }}</span>
                                        {% else %}
                                            <span class="badge badge-inactive">{{ 'status.inactive'|trans }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ integration.lastAccessedAt ? integration.lastAccessedAt|date('d.m.Y H:i') : 'general.never'|trans }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.org-name-editable {
    display: flex;
    align-items: center;
    gap: 10px;
}

.org-name-editable .org-name {
    margin: 0;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.org-name-editable .org-name[contenteditable="true"] {
    background-color: #f0f0f0;
    border: 1px solid #007bff;
    outline: none;
}

.btn-icon-edit, .btn-icon-save, .btn-icon-cancel {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.btn-icon-edit:hover, .btn-icon-save:hover, .btn-icon-cancel:hover {
    background-color: #f0f0f0;
}

.btn-icon-save {
    color: #28a745;
}

.btn-icon-cancel {
    color: #dc3545;
}

.btn-icon-edit {
    color: #6c757d;
}

.curl-command-section {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.btn-copy-curl {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background-color: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-copy-curl:hover {
    background-color: #5a6268;
}

.copied-message {
    color: #28a745;
    font-weight: 500;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

{% if is_granted('ROLE_ADMIN') %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orgNameEl = document.getElementById('orgName');
    const editBtn = document.getElementById('editOrgNameBtn');
    const saveBtn = document.getElementById('saveOrgNameBtn');
    const cancelBtn = document.getElementById('cancelOrgNameBtn');
    let originalName = orgNameEl.textContent.trim();

    function enterEditMode() {
        orgNameEl.contentEditable = true;
        orgNameEl.focus();
        editBtn.style.display = 'none';
        saveBtn.style.display = 'flex';
        cancelBtn.style.display = 'flex';
        
        // Select all text
        const range = document.createRange();
        range.selectNodeContents(orgNameEl);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }

    function exitEditMode(save = false) {
        orgNameEl.contentEditable = false;
        editBtn.style.display = 'flex';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        
        if (!save) {
            orgNameEl.textContent = originalName;
        }
    }

    async function saveOrgName() {
        const newName = orgNameEl.textContent.trim();
        
        if (!newName) {
            alert('{{ 'general.org_name_empty'|trans|default('Organisation name cannot be empty') }}');
            orgNameEl.textContent = originalName;
            exitEditMode(false);
            return;
        }

        if (newName === originalName) {
            exitEditMode(true);
            return;
        }

        try {
            const response = await fetch('{{ path('app_organisation_update_name') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ name: newName })
            });

            const data = await response.json();
            
            if (data.success) {
                originalName = newName;
                exitEditMode(true);
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success';
                successMsg.textContent = data.message || '{{ 'general.org_name_updated'|trans|default('Organisation name updated successfully') }}';
                document.querySelector('.dashboard-container').insertBefore(successMsg, document.querySelector('.organisation-info'));
                setTimeout(() => successMsg.remove(), 3000);
            } else {
                alert(data.error || '{{ 'general.org_name_update_error'|trans|default('Failed to update organisation name') }}');
                orgNameEl.textContent = originalName;
                exitEditMode(false);
            }
        } catch (error) {
            console.error('Error updating organisation name:', error);
            alert('{{ 'general.org_name_update_error'|trans|default('Failed to update organisation name') }}');
            orgNameEl.textContent = originalName;
            exitEditMode(false);
        }
    }

    editBtn.addEventListener('click', enterEditMode);
    saveBtn.addEventListener('click', saveOrgName);
    cancelBtn.addEventListener('click', () => exitEditMode(false));

    // Handle Enter and Escape keys
    orgNameEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveOrgName();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            exitEditMode(false);
        }
    });
});
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const copyCurlBtn = document.getElementById('copyCurlBtn');
    const copiedMessage = document.getElementById('copiedMessage');

    if (copyCurlBtn) {
        copyCurlBtn.addEventListener('click', function() {
            // Get the current domain
            const currentDomain = window.location.origin;

            // Get organisation UUID from the API URL
            const orgUuid = '{{ organisation.uuid }}';

            // Get workflow user ID
            const workflowUserId = '{{ userOrganisation.workflowUserId }}';

            // Construct the curl command
            const apiUrl = `${currentDomain}/api/integration/${orgUuid}/tools?id=${workflowUserId}`;
            const curlCommand = `curl -X GET "${apiUrl}" \\
  -H "Accept: application/json" \\
  -H "Authorization: Basic YOUR_AUTH_TOKEN"`;

            // Copy to clipboard
            navigator.clipboard.writeText(curlCommand).then(function() {
                // Show success message
                copiedMessage.style.display = 'inline';

                // Hide message after 2 seconds
                setTimeout(function() {
                    copiedMessage.style.display = 'none';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        });
    }
});
</script>
{% endblock %}