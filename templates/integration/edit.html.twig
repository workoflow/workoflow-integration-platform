{% extends 'base.html.twig' %}

{% block title %}{{ 'integration.edit'|trans|default('Edit Integration') }} - Workoflow{% endblock %}

{% block body %}
<div class="dashboard-page">
    {% include '_partials/header.html.twig' %}

    <div class="dashboard-container">
        <h1 class="dashboard-title">{{ 'integration.edit'|trans|default('Edit Integration') }}</h1>

        <div class="integration-form-container">
            <form method="post" id="integrationForm" class="integration-form">
                <div class="form-section">
                    <h2 class="section-title">{{ 'integration.basic_info'|trans|default('Basic Information') }}</h2>

                    <div class="form-group">
                        <label class="form-label">{{ 'integration.type'|trans|default('Type') }}</label>
                        <div class="form-readonly">
                            <span class="badge badge-type">{{ integration.type|upper }}</span>
                            <span class="integration-type-name">{{ integration.name }}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="name" class="form-label">{{ 'integration.name'|trans|default('Name') }}</label>
                        <input type="text" class="form-control" id="name" name="name"
                               value="{{ integration.instanceName }}" required
                               placeholder="{{ 'integration.name_placeholder'|trans|default('e.g., Production Jira') }}">
                    </div>
                </div>

                {% if integration.credentialFields|length > 0 %}
                <div class="form-section">
                    <h2 class="section-title">{{ 'integration.credentials'|trans|default('Credentials') }}</h2>
                    <p class="section-note">
                        <i class="fas fa-info-circle"></i>
                        {{ 'integration.credentials_update_note'|trans|default('Leave fields empty to keep existing credentials') }}
                    </p>

                    <div id="credentialFields">
                        {% for field in integration.credentialFields %}
                            {% if field.type != 'oauth' %}
                            <div class="form-group">
                                <label for="{{ integration.type }}_{{ field.name }}" class="form-label">
                                    {{ field.label }}
                                    <span class="optional">({{ 'common.optional'|trans|default('optional') }})</span>
                                </label>
                                <input type="{{ field.type == 'password' ? 'password' : field.type }}"
                                       class="form-control"
                                       id="{{ integration.type }}_{{ field.name }}"
                                       name="{{ integration.type }}_{{ field.name }}"
                                       placeholder="{{ field.placeholder|default('Enter new value to update') }}">
                                {% if field.description %}
                                    <small class="form-text text-muted">{{ field.description }}</small>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="form-group">
                                <div class="oauth-notice">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>{{ field.description|default('OAuth authentication is configured separately') }}</span>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="form-section">
                    <h2 class="section-title">{{ 'integration.available_functions'|trans|default('Available Tools') }}</h2>
                    <div id="functionsList">
                        {% for tool in integration.tools %}
                        <div class="function-checkbox">
                            <input type="checkbox"
                                   id="function_{{ tool.name }}"
                                   name="function_{{ tool.name }}"
                                   {% if tool.enabled %}checked{% endif %}>
                            <label for="function_{{ tool.name }}">
                                <strong>{{ tool.name }}</strong>
                                <br>
                                <small class="text-muted">{{ tool.description }}</small>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-section">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> {{ 'common.save_changes'|trans|default('Save Changes') }}
                    </button>
                    <a href="{{ path('app_integrations') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> {{ 'common.cancel'|trans|default('Cancel') }}
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.form-readonly {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
}

.integration-type-name {
    color: var(--text-primary);
    font-weight: 500;
}

.badge-type {
    background: var(--secondary-background);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
}

.section-note {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: var(--border-radius);
    padding: var(--space-md);
    color: var(--text-secondary);
    font-size: var(--text-sm);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.section-note i {
    color: #ffc107;
}

.oauth-notice {
    background: var(--bg-secondary);
    padding: var(--space-lg);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    border-left: 4px solid var(--color-primary);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    transition: var(--transition);
}

.oauth-notice:hover {
    background: var(--bg-primary);
    border-color: rgba(255, 107, 53, 0.3);
}

.oauth-notice i {
    color: var(--color-primary);
    font-size: var(--text-lg);
}

.oauth-notice span {
    color: var(--text-secondary);
    font-size: var(--text-sm);
    line-height: 1.4;
}

.function-checkbox {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.function-checkbox:hover {
    background: var(--bg-primary);
    border-color: rgba(255, 107, 53, 0.2);
}

.function-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    margin-top: 2px;
    accent-color: var(--color-primary);
    cursor: pointer;
}

.function-checkbox label {
    flex: 1;
    cursor: pointer;
}

.function-checkbox label strong {
    display: block;
    font-weight: 600;
    font-size: var(--text-sm);
    margin-bottom: var(--space-xs);
    color: var(--text-primary);
}

.function-checkbox label small {
    display: block;
    font-size: var(--text-xs);
    color: var(--text-secondary);
    line-height: 1.4;
}

.form-text.text-muted {
    font-size: var(--text-xs);
    margin-top: var(--space-xs);
    color: var(--text-muted);
}

.optional {
    font-size: var(--text-xs);
    color: var(--text-muted);
    font-weight: normal;
    margin-left: var(--space-xs);
}

.btn i {
    margin-right: var(--space-xs);
}
</style>
{% endblock %}