{% extends 'base.html.twig' %}

{% block title %}{{ 'prompt.vault_title'|trans }} - Workoflow{% endblock %}

{% block body %}
<div class="prompts-page">
    <div class="prompts-container">
        <div class="prompts-hero">
            <h1>{{ 'prompt.vault_title'|trans }}</h1>
            <div class="prompts-explanation">
                <p>{{ 'prompt.explanation_p1'|trans }}</p>
                <p>{{ 'prompt.explanation_p2'|trans }}</p>
            </div>
        </div>

        {# API Helper Section - Collapsible #}
        <div class="api-helper-section" id="apiHelperSection" style="display: none;">
            <div class="api-helper-content">
                <div class="api-helper-header">
                    <h3><i class="fas fa-terminal"></i> {{ 'prompt.api_access'|trans }}</h3>
                    <button type="button" class="btn-close" onclick="toggleApiHelper()">&times;</button>
                </div>

                {% if userOrganisation and userOrganisation.hasToken() %}
                    <div class="api-helper-grid">
                        {# Get Personal Prompts #}
                        <div class="api-helper-item">
                            <label><i class="fas fa-user"></i> {{ 'prompt.api.get_personal'|trans }}</label>
                            <div class="curl-command-wrapper">
                                <pre><code id="curlPersonal">curl -H "X-Prompt-Token: {{ userOrganisation.personalAccessToken }}" "{{ app.request.schemeAndHttpHost }}/api/prompts?scope=personal"</code></pre>
                                <button type="button" class="btn btn-copy btn-sm" onclick="copyCurl(this, 'curlPersonal')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        {# Get Team Prompts #}
                        <div class="api-helper-item">
                            <label><i class="fas fa-users"></i> {{ 'prompt.api.get_team'|trans }}</label>
                            <div class="curl-command-wrapper">
                                <pre><code id="curlTeam">curl -H "X-Prompt-Token: {{ userOrganisation.personalAccessToken }}" "{{ app.request.schemeAndHttpHost }}/api/prompts?scope=organisation"</code></pre>
                                <button type="button" class="btn btn-copy btn-sm" onclick="copyCurl(this, 'curlTeam')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        {# Get All Prompts #}
                        <div class="api-helper-item">
                            <label><i class="fas fa-list"></i> {{ 'prompt.api.get_all'|trans }}</label>
                            <div class="curl-command-wrapper">
                                <pre><code id="curlAll">curl -H "X-Prompt-Token: {{ userOrganisation.personalAccessToken }}" "{{ app.request.schemeAndHttpHost }}/api/prompts"</code></pre>
                                <button type="button" class="btn btn-copy btn-sm" onclick="copyCurl(this, 'curlAll')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        {# Get by UUID #}
                        <div class="api-helper-item">
                            <label><i class="fas fa-fingerprint"></i> {{ 'prompt.api.get_by_uuid'|trans }}</label>
                            <div class="curl-command-wrapper">
                                <pre><code id="curlUuid">curl -H "X-Prompt-Token: {{ userOrganisation.personalAccessToken }}" "{{ app.request.schemeAndHttpHost }}/api/prompts?uuid=YOUR_PROMPT_UUID"</code></pre>
                                <button type="button" class="btn btn-copy btn-sm" onclick="copyCurl(this, 'curlUuid')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>

                        {# Filter by Category #}
                        <div class="api-helper-item">
                            <label><i class="fas fa-tag"></i> {{ 'prompt.api.filter_category'|trans }}</label>
                            <div class="curl-command-wrapper">
                                <pre><code id="curlCategory">curl -H "X-Prompt-Token: {{ userOrganisation.personalAccessToken }}" "{{ app.request.schemeAndHttpHost }}/api/prompts?category=developer"</code></pre>
                                <button type="button" class="btn btn-copy btn-sm" onclick="copyCurl(this, 'curlCategory')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="api-helper-footer">
                        <p class="api-helper-hint">
                            <i class="fas fa-info-circle"></i>
                            {{ 'prompt.api.hint_combine'|trans }}
                        </p>
                    </div>
                {% else %}
                    <div class="api-helper-no-token">
                        <i class="fas fa-key"></i>
                        <p>{{ 'prompt.api.no_token'|trans }}</p>
                        <a href="{{ path('app_profile') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-cog"></i> {{ 'prompt.api.generate_token'|trans }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Scope Tabs with Actions #}
        <div class="prompts-tabs-row">
            <div class="prompts-tabs">
                <a href="{{ path('app_prompts', {scope: 'personal', category: activeCategory, sort: activeSort}) }}"
                   class="tab-btn {% if activeScope == 'personal' %}active{% endif %}">
                    <i class="fas fa-user"></i>
                    {{ 'prompt.tab.personal'|trans }}
                    <span class="tab-count">{{ counts.personal }}</span>
                </a>
                <a href="{{ path('app_prompts', {scope: 'organisation', category: activeCategory, sort: activeSort}) }}"
                   class="tab-btn {% if activeScope == 'organisation' %}active{% endif %}">
                    <i class="fas fa-users"></i>
                    {{ 'prompt.tab.organisation'|trans }}
                    <span class="tab-count">{{ counts.organisation }}</span>
                </a>
            </div>
            <div class="prompts-actions">
                <button type="button" class="btn btn-secondary btn-sm" onclick="toggleApiHelper()">
                    <i class="fas fa-code"></i> {{ 'prompt.api_helper'|trans }}
                </button>
                <a href="{{ path('app_prompt_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {{ 'prompt.create_new'|trans }}
                </a>
            </div>
        </div>

        {# Filters: Category & Sort #}
        <div class="prompts-filters">
            <form method="get" action="{{ path('app_prompts') }}" class="filter-form" id="filterForm">
                <input type="hidden" name="scope" value="{{ activeScope }}">

                <div class="filter-group">
                    <label class="filter-label"><i class="fas fa-tag"></i> {{ 'prompt.filter.category'|trans }}</label>
                    <select name="category" class="form-control filter-select" onchange="this.form.submit()">
                        <option value="">{{ 'prompt.filter.all_categories'|trans }}</option>
                        {% for value, label in categories %}
                            <option value="{{ value }}" {% if activeCategory == value %}selected{% endif %}>
                                {{ label|trans }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label"><i class="fas fa-sort"></i> {{ 'prompt.filter.sort'|trans }}</label>
                    <select name="sort" class="form-control filter-select" onchange="this.form.submit()">
                        {% for value, label in sortOptions %}
                            <option value="{{ value }}" {% if activeSort == value %}selected{% endif %}>
                                {{ label|trans }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        {# Prompt Cards Grid #}
        <div class="prompts-grid">
            {% for prompt in prompts %}
                {% include 'prompt/_card.html.twig' %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-lightbulb empty-icon"></i>
                    <h3>{{ 'prompt.no_prompts'|trans }}</h3>
                    <p>{{ 'prompt.no_prompts_desc'|trans }}</p>
                    <a href="{{ path('app_prompt_new') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> {{ 'prompt.create_new'|trans }}
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function toggleApiHelper() {
    const section = document.getElementById('apiHelperSection');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        // Smooth scroll to the section
        section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        section.style.display = 'none';
    }
}

function copyCurl(btn, elementId) {
    const code = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(code).then(function() {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.add('copied');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('copied');
        }, 2000);
    });
}
</script>
{% endblock %}
