<!-- Global Header -->
<header class="global-header">
    <div class="header-content">
        <a href="{{ app.user ? path('app_home') : '/' }}" class="header-brand">
            <div class="header-logo">
                <div class="header-logo-circle"></div>
                <img src="{{ asset('images/valantic-logo-white.png') }}" alt="Valantic Logo" class="header-logo-icon">
            </div>
            <div class="header-title-container">
                <span class="header-title">Workoflow Integration Platform</span>
                <span class="header-subtitle">EFFICIENCY IS YOURS</span>
            </div>
        </a>
        <nav class="header-nav">
            {% if app.user %}
                {# Language Switcher #}
                {% set currentLocale = app.request.locale %}
                <div class="language-switcher">
                    <button class="language-switcher-button" onclick="toggleLangDropdown(event)">
                        <span class="lang-flag fi fi-{{ currentLocale == 'de' ? 'de' : 'gb' }}"></span>
                        <span class="lang-name">{{ currentLocale == 'de' ? 'DE' : 'EN' }}</span>
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M6 9L1 4h10L6 9z"/>
                        </svg>
                    </button>
                    <div class="language-dropdown" id="langDropdown" style="display: none;">
                        <a href="{{ path('app_locale_switch', {'locale': 'en'}) }}"
                           class="lang-item {% if currentLocale == 'en' %}active{% endif %}">
                            <span class="lang-flag fi fi-gb"></span>
                            <span>English</span>
                            {% if currentLocale == 'en' %}
                                <span class="current-indicator">✓</span>
                            {% endif %}
                        </a>
                        <a href="{{ path('app_locale_switch', {'locale': 'de'}) }}"
                           class="lang-item {% if currentLocale == 'de' %}active{% endif %}">
                            <span class="lang-flag fi fi-de"></span>
                            <span>Deutsch</span>
                            {% if currentLocale == 'de' %}
                                <span class="current-indicator">✓</span>
                            {% endif %}
                        </a>
                    </div>
                </div>

                {% set currentOrgId = app.session.get('current_organisation_id') %}
                {% set currentOrg = app.user.getCurrentOrganisation(currentOrgId) %}
                {% set userOrganisations = app.user.organisations %}

                {% if userOrganisations|length > 1 %}
                    <div class="organisation-switcher">
                        <button class="organisation-switcher-button" onclick="toggleOrgDropdown(event)">
                            <span class="org-name">{{ currentOrg ? currentOrg.name : 'Select Organisation' }}</span>
                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 9L1 4h10L6 9z"/>
                            </svg>
                        </button>
                        <div class="organisation-dropdown" id="orgDropdown" style="display: none;">
                            {% for org in userOrganisations %}
                                <a href="{{ path('app_organisation_switch', {'id': org.id}) }}" 
                                   class="org-item {% if currentOrg and org.id == currentOrg.id %}active{% endif %}">
                                    {{ org.name }}
                                    {% if currentOrg and org.id == currentOrg.id %}
                                        <span class="current-indicator">✓</span>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% elseif currentOrg %}
                    <span class="single-org-display">{{ currentOrg.name }}</span>
                {% endif %}
                
                {# Workspace Dropdown #}
                <div class="nav-dropdown" data-controller="nav-dropdown">
                    <button type="button"
                            data-action="click->nav-dropdown#toggle"
                            data-nav-dropdown-target="button"
                            aria-expanded="false"
                            aria-haspopup="true">
                        <i class="fas fa-layer-group" aria-hidden="true"></i>
                        <span>{{ 'nav.workspace'|trans }}</span>
                        <i class="fas fa-chevron-down dropdown-arrow" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu" data-nav-dropdown-target="menu" style="display: none;">
                        <a href="{{ path('app_general') }}" class="dropdown-item">
                            <i class="fas fa-home" aria-hidden="true"></i>
                            <span>{{ 'nav.general'|trans }}</span>
                        </a>
                        <a href="{{ path('app_skills') }}" class="dropdown-item">
                            <i class="fas fa-plug" aria-hidden="true"></i>
                            <span>{{ 'nav.skills'|trans }}</span>
                        </a>
                        <a href="{{ path('app_prompts') }}" class="dropdown-item">
                            <i class="fas fa-lightbulb" aria-hidden="true"></i>
                            <span>{{ 'nav.prompt_vault'|trans }}</span>
                        </a>
                        <a href="{{ path('app_files') }}" class="dropdown-item">
                            <i class="fas fa-folder" aria-hidden="true"></i>
                            <span>{{ 'nav.files'|trans }}</span>
                        </a>
                        <a href="{{ path('app_channel') }}" class="dropdown-item">
                            <i class="fas fa-comments" aria-hidden="true"></i>
                            <span>{{ 'nav.channel'|trans }}</span>
                        </a>
                    </div>
                </div>

                {# Settings Dropdown #}
                <div class="nav-dropdown" data-controller="nav-dropdown">
                    <button type="button"
                            data-action="click->nav-dropdown#toggle"
                            data-nav-dropdown-target="button"
                            aria-expanded="false"
                            aria-haspopup="true">
                        <i class="fas fa-gear" aria-hidden="true"></i>
                        <span>{{ 'nav.settings'|trans }}</span>
                        <i class="fas fa-chevron-down dropdown-arrow" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu" data-nav-dropdown-target="menu" style="display: none;">
                        <a href="{{ path('app_profile') }}" class="dropdown-item">
                            <i class="fas fa-user" aria-hidden="true"></i>
                            <span>{{ 'nav.profile'|trans }}</span>
                        </a>
                        {% if app.user.isAdmin() %}
                            <a href="{{ path('app_organisation_members') }}" class="dropdown-item">
                                <i class="fas fa-users" aria-hidden="true"></i>
                                <span>{{ 'nav.members'|trans }}</span>
                            </a>
                        {% endif %}
                        <a href="{{ path('app_release_notes') }}" class="dropdown-item">
                            <i class="fas fa-file-alt" aria-hidden="true"></i>
                            <span>{{ 'nav.release_notes'|trans }}</span>
                        </a>
                        <a href="{{ path('app_audit_log') }}" class="dropdown-item">
                            <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                            <span>{{ 'nav.audit_log'|trans }}</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{{ path('app_logout') }}" class="dropdown-item logout-item">
                            <i class="fas fa-right-from-bracket" aria-hidden="true"></i>
                            <span>{{ 'nav.logout'|trans }}</span>
                        </a>
                    </div>
                </div>
            {% else %}
                <a href="{{ path('app_login') }}" class="header-link">{{ 'nav.login'|trans }}</a>
            {% endif %}
        </nav>
    </div>
</header>

<script>
function toggleLangDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('langDropdown');
    const orgDropdown = document.getElementById('orgDropdown');
    // Close org dropdown if open
    if (orgDropdown) {
        orgDropdown.style.display = 'none';
    }
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleOrgDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('orgDropdown');
    const langDropdown = document.getElementById('langDropdown');
    // Close lang dropdown if open
    if (langDropdown) {
        langDropdown.style.display = 'none';
    }
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const orgDropdown = document.getElementById('orgDropdown');
    const langDropdown = document.getElementById('langDropdown');
    const orgSwitcher = document.querySelector('.organisation-switcher');
    const langSwitcher = document.querySelector('.language-switcher');

    if (orgDropdown && !orgSwitcher?.contains(event.target)) {
        orgDropdown.style.display = 'none';
    }

    if (langDropdown && !langSwitcher?.contains(event.target)) {
        langDropdown.style.display = 'none';
    }
});
</script>